<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Formation.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">esms-ai</a> &gt; <a href="index.source.html" class="el_package">com.ljs.ifootballmanager.ai.formation</a> &gt; <span class="el_source">Formation.java</span></div><h1>Formation.java</h1><pre class="source lang-java linenums">package com.ljs.ifootballmanager.ai.formation;

import com.google.common.base.Function;
import com.google.common.base.Preconditions;
import com.google.common.base.Predicate;
import com.google.common.collect.FluentIterable;
import com.google.common.collect.ImmutableList;
import com.google.common.collect.ImmutableSet;
import com.google.common.collect.Lists;
import com.google.common.collect.Multimap;
import com.google.common.collect.Ordering;
import com.google.common.collect.Sets;
import com.ljs.ai.search.hillclimbing.HillClimbing;
import com.ljs.ai.search.hillclimbing.RepeatedHillClimbing;
import com.ljs.ai.search.hillclimbing.Validator;
import com.ljs.ifootballmanager.ai.Role;
import com.ljs.ifootballmanager.ai.Tactic;
import com.ljs.ifootballmanager.ai.formation.score.DefaultScorer;
import com.ljs.ifootballmanager.ai.formation.score.FormationScorer;
import com.ljs.ifootballmanager.ai.formation.selection.Actions;
import com.ljs.ifootballmanager.ai.formation.selection.RandomFormationGenerator;
import com.ljs.ifootballmanager.ai.formation.validate.FormationValidator;
import com.ljs.ifootballmanager.ai.league.League;
import com.ljs.ifootballmanager.ai.player.Player;
import com.ljs.ifootballmanager.ai.player.SquadHolder;
import com.ljs.ifootballmanager.ai.rating.Rating;
import com.ljs.ifootballmanager.ai.report.Report;
import com.ljs.ifootballmanager.ai.selection.Substitution;
import java.io.PrintWriter;
import java.util.List;
import java.util.Random;
import java.util.Set;

/**
 *
 * @author lstephen
 */
public final class Formation implements Report {

    private final FormationValidator validator;

    private final FormationScorer scorer;

    private final FormationMap positions;

    private final Tactic tactic;

<span class="nc" id="L48">    private Formation(FormationValidator validator, FormationScorer scorer, Tactic tactic, FormationMap in) {</span>
<span class="nc" id="L49">        this.validator = validator;</span>
<span class="nc" id="L50">        this.scorer = scorer;</span>
<span class="nc" id="L51">        this.tactic = tactic;</span>
<span class="nc" id="L52">        this.positions = in;</span>
<span class="nc" id="L53">    }</span>

    public FormationValidator getValidator() {
<span class="nc" id="L56">        return validator;</span>
    }

    public Tactic getTactic() {
<span class="nc" id="L60">        return tactic;</span>
    }

    public FormationScorer getScorer() {
<span class="nc" id="L64">        return scorer;</span>
    }

    public Formation withScorer(FormationScorer scorer) {
<span class="nc" id="L68">        return new Formation(validator, scorer, tactic, positions);</span>
    }

    public Formation withTactic(Tactic tactic) {
<span class="nc" id="L72">        return new Formation(validator, scorer, tactic, positions);</span>
    }

    public Formation withUpdatedPlayers(Iterable&lt;Player&gt; ps) {
<span class="nc" id="L76">        FormationMap f = FormationMap.create(positions);</span>

<span class="nc bnc" id="L78" title="All 2 branches missed.">        for (Player p : ps) {</span>
<span class="nc" id="L79">            Role r = findRole(p);</span>
<span class="nc" id="L80">            f.remove(r, p);</span>
<span class="nc" id="L81">            f.put(r, p);</span>
<span class="nc" id="L82">        }</span>

<span class="nc" id="L84">        return new Formation(validator, scorer, tactic, f);</span>
    }

    public Player getPenaltyKicker() {
<span class="nc" id="L88">        return Player</span>
<span class="nc" id="L89">            .bySkill(Rating.SHOOTING)</span>
<span class="nc" id="L90">            .compound(Player.byTieBreak())</span>
<span class="nc" id="L91">            .max(players());</span>
    }

    public ImmutableSet&lt;Role&gt; getRoles() {
<span class="nc" id="L95">        return ImmutableSet.copyOf(positions.roles());</span>
    }

    public Formation move(Role r, Player p) {
<span class="nc" id="L99">        FormationMap f = FormationMap.create(positions);</span>

<span class="nc bnc" id="L101" title="All 2 branches missed.">        if (contains(p)) {</span>
<span class="nc" id="L102">            Player inFormation = findInFormation(p);</span>

<span class="nc" id="L104">            f.remove(findRole(inFormation), inFormation);</span>

<span class="nc" id="L106">            f.put(r, inFormation);</span>
<span class="nc" id="L107">        } else {</span>
<span class="nc" id="L108">            f.put(r, p);</span>
        }

<span class="nc" id="L111">        return Formation.create(validator, scorer, tactic, f);</span>
    }

    public Role findRole(Player p) {
<span class="nc" id="L115">        return positions.get(p);</span>
    }

    private Player findInFormation(Player p) {
<span class="nc" id="L119">        Role r = findRole(p);</span>

<span class="nc bnc" id="L121" title="All 2 branches missed.">        for (Player inFormation : positions.get(r)) {</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">            if (p.equals(inFormation)) {</span>
<span class="nc" id="L123">                return inFormation;</span>
            }
<span class="nc" id="L125">        }</span>

<span class="nc" id="L127">        throw new IllegalStateException();</span>
    }

    public boolean contains(Player p) {
<span class="nc" id="L131">        return positions.contains(p);</span>
    }

    public ImmutableSet&lt;Player&gt; players(Role r) {
<span class="nc" id="L135">        return ImmutableSet.copyOf(positions.get(r));</span>
    }

    public ImmutableList&lt;Player&gt; players() {
<span class="nc" id="L139">        List&lt;Player&gt; players = Lists.newArrayList();</span>

<span class="nc bnc" id="L141" title="All 2 branches missed.">        for (Role r : Ordering.natural().sortedCopy(positions.roles())) {</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">            for (Player p : SquadHolder.get().getOrdering().sortedCopy(positions.get(r))) {</span>
<span class="nc" id="L143">                players.add(p);</span>
<span class="nc" id="L144">            }</span>
<span class="nc" id="L145">        }</span>

<span class="nc" id="L147">        return ImmutableList.copyOf(players);</span>
    }

    public Iterable&lt;Player&gt; unsortedPlayers() {
<span class="nc" id="L151">        return positions.players();</span>
    }

    private Formation substitute(Substitution s) {
<span class="nc" id="L155">        return substitute(s.getIn(), s.getRole(), s.getOut());</span>
    }

    public Formation substitute(Player in, Role r, Player out) {
<span class="nc" id="L159">        FormationMap f = FormationMap.create(positions);</span>

<span class="nc" id="L161">        f.remove(findRole(out), out);</span>
<span class="nc" id="L162">        f.put(r, in);</span>

<span class="nc" id="L164">        return Formation.create(validator, scorer, tactic, f);</span>
    }

    public boolean isValid(Substitution s) {
<span class="nc bnc" id="L168" title="All 2 branches missed.">        if (!contains(s.getOut())) {</span>
<span class="nc" id="L169">            return false;</span>
        }
<span class="nc bnc" id="L171" title="All 2 branches missed.">        if (s.getRole().equals(findRole(s.getOut()))) {</span>
<span class="nc" id="L172">            return true;</span>
        }
<span class="nc" id="L174">        return substitute(s).isValid();</span>
    }

    public Double score() {
<span class="nc" id="L178">        return scorer.score(this, tactic);</span>
    }

    public Double score(Tactic tactic) {
<span class="nc" id="L182">        return scorer.score(this, tactic);</span>
    }

    public Double scoring() {
<span class="nc" id="L186">        return scoring(tactic);</span>
    }

    public Double scoring(Tactic tactic) {
<span class="nc" id="L190">        return scorer.scoring(this, tactic);</span>
    }

    public Double defending() {
<span class="nc" id="L194">        return defending(tactic);</span>
    }

    public Double defending(Tactic tactic) {
<span class="nc" id="L198">        return scorer.defending(this, tactic);</span>
    }

    public Boolean isValid() {
<span class="nc bnc" id="L202" title="All 2 branches missed.">        if (positions.size() != 11) {</span>
<span class="nc" id="L203">            return false;</span>
        }
<span class="nc bnc" id="L205" title="All 2 branches missed.">        if (ImmutableSet.copyOf(positions.players()).size() != 11) {</span>
<span class="nc" id="L206">            return false;</span>
        }

<span class="nc" id="L209">        return validator.isValid(this);</span>
    }

    public Integer count(Role r) {
<span class="nc" id="L213">        return positions.get(r).size();</span>
    }

    public Integer count(Iterable&lt;Role&gt; rs) {
<span class="nc" id="L217">        Integer count = 0;</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">        for (Role r : rs) {</span>
<span class="nc" id="L219">            count += count(r);</span>
<span class="nc" id="L220">        }</span>
<span class="nc" id="L221">        return count;</span>
    }

    public void print(PrintWriter w) {
<span class="nc" id="L225">        w.format(&quot;%s%n&quot;, getTactic());</span>
<span class="nc" id="L226">        printPlayers(w);</span>

<span class="nc" id="L228">        scorer.print(this, w);</span>
<span class="nc" id="L229">    }</span>

    public void printPlayers(PrintWriter w) {
<span class="nc bnc" id="L232" title="All 2 branches missed.">        for (Player p : players()) {</span>
<span class="nc" id="L233">            w.format(&quot;%s %s%n&quot;, findRole(p), p.getName());</span>
<span class="nc" id="L234">        }</span>
<span class="nc" id="L235">    }</span>

    public static Formation create(FormationValidator validator, FormationScorer scorer, Tactic tactic, Multimap&lt;Role, Player&gt; players) {
<span class="nc" id="L238">        return create(validator, scorer, tactic, FormationMap.create(players));</span>
    }

    public static Formation create(FormationValidator validator, FormationScorer scorer, Tactic tactic, FormationMap players) {
<span class="nc" id="L242">        return new Formation(validator, scorer, tactic, players);</span>
    }

    public static Formation create(FormationValidator validator, Tactic tactic, Multimap&lt;Role, Player&gt; players) {
<span class="nc" id="L246">        return create(validator, DefaultScorer.get(), tactic, players);</span>
    }

    public static ImmutableList&lt;Formation&gt; select(League league, Iterable&lt;Player&gt; available, FormationScorer scorer) {
<span class="nc" id="L250">        return select(league, SelectionCriteria.create(league, available), scorer);</span>
    }

    public static Formation select(League league, Tactic tactic, Iterable&lt;Player&gt; available, FormationScorer scorer) {
<span class="nc" id="L254">        return select(league, tactic, SelectionCriteria.create(league, available), scorer);</span>
    }

    public static ImmutableList&lt;Formation&gt; select(League league, SelectionCriteria criteria, FormationScorer scorer) {
<span class="nc" id="L258">        Set&lt;Formation&gt; formations = Sets.newHashSet();</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">        for (Tactic t : Tactic.values()) {</span>
<span class="nc" id="L260">            formations.add(select(league, t, criteria, scorer));</span>
        }

<span class="nc bnc" id="L263" title="All 2 branches missed.">        Preconditions.checkState(formations.size() == Tactic.values().length);</span>

<span class="nc" id="L265">        final Double max = byScore(scorer).max(formations).score();</span>

<span class="nc" id="L267">        return byScore(scorer)</span>
<span class="nc" id="L268">            .reverse()</span>
<span class="nc" id="L269">            .immutableSortedCopy(</span>
                FluentIterable
<span class="nc" id="L271">                    .from(formations)</span>
<span class="nc" id="L272">                    .filter(new Predicate&lt;Formation&gt;() {</span>
                        public boolean apply(Formation f) {
<span class="nc bnc" id="L274" title="All 2 branches missed.">                            return f.score() &gt; max * 0.95;</span>
                        }
                    })
                );
    }

    public static Formation selectOne(League league, SelectionCriteria criteria, FormationScorer scorer) {
<span class="nc" id="L281">        ImmutableList&lt;Formation&gt; candidates = select(league, criteria, scorer);</span>

<span class="nc" id="L283">        Double base = candidates.get(0).score() * .95 - 1;</span>

<span class="nc" id="L285">        List&lt;Formation&gt; weighted = Lists.newArrayList();</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">        for (Formation f : candidates) {</span>
<span class="nc" id="L287">            int weighting = (int) Math.round(f.score() - base);</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">            for (int i = 0; i &lt; weighting; i++) {</span>
<span class="nc" id="L289">                weighted.add(f);</span>
            }
<span class="nc" id="L291">            System.out.print(f.getTactic().getCode() + &quot;:&quot; + weighting + &quot; &quot;);</span>
<span class="nc" id="L292">        }</span>

<span class="nc" id="L294">        List&lt;Formation&gt; weightedList = Lists.newArrayList(weighted);</span>

<span class="nc" id="L296">        Double seed = 0.0;</span>

<span class="nc bnc" id="L298" title="All 2 branches missed.">        for (Player p : criteria.getAll()) {</span>
<span class="nc" id="L299">            seed += p.getAbilitiesSum();</span>
<span class="nc" id="L300">            seed += p.getGames();</span>
<span class="nc" id="L301">        }</span>

<span class="nc" id="L303">        Random r = new Random(Math.round(seed));</span>

<span class="nc" id="L305">        Integer idx = r.nextInt(weightedList.size());</span>

<span class="nc" id="L307">        System.out.println(&quot;(&quot; + weightedList.size() + &quot;) -&gt; &quot; + weightedList.get(idx).getTactic());</span>

<span class="nc" id="L309">        return weightedList.get(idx);</span>
    }

    private static Formation select(League league, Tactic tactic, SelectionCriteria criteria, FormationScorer scorer) {

        HillClimbing.Builder&lt;Formation&gt; builder = HillClimbing
<span class="nc" id="L315">            .&lt;Formation&gt;builder()</span>
<span class="nc" id="L316">            .validator(new Validator&lt;Formation&gt;() {</span>
                @Override
                public Boolean apply(Formation f) {
<span class="nc" id="L319">                    return f.isValid();</span>
                }
            })
<span class="nc" id="L322">            .heuristic(byScore(scorer).compound(byAge().reverse()).compound(byAbilitySum()))</span>
<span class="nc" id="L323">            .actionGenerator(Actions.create(criteria));</span>

<span class="nc" id="L325">        return new RepeatedHillClimbing&lt;Formation&gt;(</span>
<span class="nc" id="L326">            RandomFormationGenerator.create(league.getFormationValidator(), scorer, tactic, criteria),</span>
            builder)
<span class="nc" id="L328">            .search();</span>
    }

    private static Ordering&lt;Formation&gt; byScore(final FormationScorer scorer) {
        return Ordering
<span class="nc" id="L333">            .natural()</span>
<span class="nc" id="L334">            .onResultOf(new Function&lt;Formation, Double&gt;() {</span>
                public Double apply(Formation f) {
<span class="nc" id="L336">                    return scorer.score(f, f.getTactic());</span>
                }
            });
    }

    private static Ordering&lt;Formation&gt; byAge() {
        return Ordering
<span class="nc" id="L343">            .natural()</span>
<span class="nc" id="L344">            .onResultOf(new Function&lt;Formation, Double&gt;() {</span>
                public Double apply(Formation f) {
<span class="nc" id="L346">                    Double sum = 0.0;</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">                    for (Player p : f.players()) {</span>
<span class="nc" id="L348">                        sum += p.getAge();</span>
<span class="nc" id="L349">                    }</span>
<span class="nc" id="L350">                    return sum;</span>
                }
            });
    }

    private static Ordering&lt;Formation&gt; byAbilitySum() {
        return Ordering
<span class="nc" id="L357">            .natural()</span>
<span class="nc" id="L358">            .onResultOf(new Function&lt;Formation, Double&gt;() {</span>
                public Double apply(Formation f) {
<span class="nc" id="L360">                    Double sum = 0.0;</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">                    for (Player p : f.players()) {</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">                        for (Rating rt : Rating.values()) {</span>
<span class="nc" id="L363">                            sum += p.getAbilityRating(f.findRole(p), f.getTactic(), rt);</span>
                        }
<span class="nc" id="L365">                    }</span>
<span class="nc" id="L366">                    return sum;</span>
                }
            });
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span></div></body></html>