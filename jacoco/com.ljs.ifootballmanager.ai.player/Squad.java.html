<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Squad.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">esms-ai</a> &gt; <a href="index.source.html" class="el_package">com.ljs.ifootballmanager.ai.player</a> &gt; <span class="el_source">Squad.java</span></div><h1>Squad.java</h1><pre class="source lang-java linenums">package com.ljs.ifootballmanager.ai.player;

import com.google.common.base.Charsets;
import com.google.common.base.CharMatcher;
import com.google.common.base.Function;
import com.google.common.base.Optional;
import com.google.common.base.Splitter;
import com.google.common.base.Strings;
import com.google.common.collect.FluentIterable;
import com.google.common.collect.ImmutableList;
import com.google.common.collect.ImmutableSet;
import com.google.common.collect.Iterables;
import com.google.common.collect.Ordering;
import com.google.common.collect.Sets;
import com.google.common.io.CharSource;
import com.google.common.io.CharStreams;
import com.google.common.io.Files;
import com.google.common.io.Resources;
import com.ljs.ifootballmanager.ai.Config;
import com.ljs.ifootballmanager.ai.Main;
import com.ljs.ifootballmanager.ai.Role;
import com.ljs.ifootballmanager.ai.Tactic;
import com.ljs.ifootballmanager.ai.league.League;
import com.ljs.ifootballmanager.ai.rating.Ratings;
import java.io.File;
import java.io.IOException;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;
import java.util.Set;
import org.apache.commons.lang3.StringUtils;
import org.assertj.core.util.Lists;

/**
 *
 * @author lstephen
 */
public final class Squad {

    private final ImmutableList&lt;Player&gt; players;

<span class="nc" id="L42">    private Squad(Iterable&lt;Player&gt; ps) {</span>
<span class="nc" id="L43">        this.players = ImmutableList.copyOf(ps);</span>
<span class="nc" id="L44">    }</span>

    public Ordering&lt;Player&gt; getOrdering() {
<span class="nc" id="L47">        return Ordering.explicit(players);</span>
    }

    public Integer getGames() {
        return Ordering
<span class="nc" id="L52">            .natural()</span>
<span class="nc" id="L53">            .max(</span>
                FluentIterable
<span class="nc" id="L55">                    .from(players())</span>
<span class="nc" id="L56">                    .transform(new Function&lt;Player, Integer&gt;() {</span>
                        public Integer apply(Player p) {
<span class="nc" id="L58">                            return p.getGames();</span>
                        }
                    }));
    }

    public ImmutableSet&lt;Player&gt; players() {
<span class="nc" id="L64">        return ImmutableSet.copyOf(players);</span>
    }

    public Player findPlayer(String name) {
<span class="nc bnc" id="L68" title="All 2 branches missed.">        for (Player p : players()) {</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">            if (name.equals(p.getName())) {</span>
<span class="nc" id="L70">                return p;</span>
            }
<span class="nc" id="L72">        }</span>
<span class="nc" id="L73">        throw new IllegalStateException(&quot;Could not find: &quot; + name);</span>
    }

    public ImmutableSet&lt;Player&gt; players(Role r, Tactic t) {
<span class="nc" id="L77">        Set&lt;Player&gt; ps = Sets.newHashSet();</span>

<span class="nc bnc" id="L79" title="All 2 branches missed.">        for (Player p : players()) {</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">            if (p.getOverall(t).getRole() == r) {</span>
<span class="nc" id="L81">                ps.add(p);</span>
            }
<span class="nc" id="L83">        }</span>
<span class="nc" id="L84">        return ImmutableSet.copyOf(ps);</span>
    }

    public ImmutableSet&lt;Player&gt; reserves(League league) {
<span class="nc" id="L88">        Set&lt;Player&gt; rs = Sets.newHashSet();</span>

<span class="nc bnc" id="L90" title="All 2 branches missed.">        for (Player p : withCap(league.getYouthSkillsCap())) {</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">            if (p.isReserves()) {</span>
<span class="nc" id="L92">                rs.add(p);</span>
            }
<span class="nc" id="L94">        }</span>

<span class="nc" id="L96">        return ImmutableSet.copyOf(rs);</span>
    }

    public Iterable&lt;Player&gt; forSelection(League league) {
<span class="nc" id="L100">        Set&lt;Optional&lt;Player&gt;&gt; ps = Sets.newHashSet();</span>

<span class="nc bnc" id="L102" title="All 2 branches missed.">        for (Player p : withCap(league.getSeniorSkillsCap())) {</span>
<span class="nc" id="L103">            ps.add(p.forSelection());</span>
<span class="nc" id="L104">        }</span>

<span class="nc" id="L106">        return Optional.presentInstances(ps);</span>
    }

    public Iterable&lt;Player&gt; forReservesSelection(League league) {
<span class="nc" id="L110">        Set&lt;Optional&lt;Player&gt;&gt; ps = Sets.newHashSet();</span>

<span class="nc" id="L112">        Optional&lt;Double&gt; cap = league.getYouthSkillsCap();</span>

<span class="nc bnc" id="L114" title="All 2 branches missed.">        for (Player p : players) {</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">            if (cap.isPresent()) {</span>
<span class="nc" id="L116">                ps.add(p.withSkillCap(cap.get()).forReservesSelection());</span>
            } else {
<span class="nc" id="L118">                ps.add(p.forReservesSelection());</span>
            }
<span class="nc" id="L120">        }</span>

<span class="nc" id="L122">        return Optional.presentInstances(ps);</span>
    }

    private Iterable&lt;Player&gt; withCap(Optional&lt;Double&gt; cap) {
<span class="nc" id="L126">        Set&lt;Player&gt; ps = Sets.newHashSet();</span>

<span class="nc bnc" id="L128" title="All 2 branches missed.">        for (Player p : players) {</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">            if (cap.isPresent()) {</span>
<span class="nc" id="L130">                ps.add(p.withSkillCap(cap.get()));</span>
            } else {
<span class="nc" id="L132">                ps.add(p);</span>
            }
<span class="nc" id="L134">        }</span>

<span class="nc" id="L136">        return ps;</span>
    }

    public Integer count(Role r) {
<span class="nc" id="L140">        Integer count = 0;</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">        for (Player p : players()) {</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">            if (p.getOverall(Tactic.NORMAL).getRole().equals(r)) {</span>
<span class="nc" id="L143">                count++;</span>
            }
<span class="nc" id="L145">        }</span>
<span class="nc" id="L146">        return count;</span>
    }

    private static Squad merge(Squad... sqs) {
<span class="nc" id="L150">        Iterable&lt;Player&gt; ps = Collections.emptyList();</span>

<span class="nc bnc" id="L152" title="All 2 branches missed.">        for (Squad s : sqs) {</span>
<span class="nc" id="L153">            ps = Iterables.concat(ps, s.players());</span>
        }

<span class="nc" id="L156">        return new Squad(ps);</span>
    }

    public static Squad load(League league) throws IOException {
<span class="nc" id="L160">        Squad first =  load(league, league.getTeam(), Boolean.FALSE);</span>

<span class="nc bnc" id="L162" title="All 2 branches missed.">        if (league.getReserveTeam().isPresent()) {</span>
<span class="nc" id="L163">            Squad reserves = load(league, league.getReserveTeam().get(), Boolean.TRUE);</span>

<span class="nc" id="L165">            return Squad.merge(first, reserves);</span>
        } else {
<span class="nc" id="L167">            return first;</span>
        }
    }

    public static Squad load(League league, CharSource source) throws IOException {
<span class="nc" id="L172">        return load(league, source, Boolean.FALSE);</span>
    }

    public static Squad load(League league, String team) throws IOException {
<span class="nc" id="L176">        return load(league, team, Boolean.FALSE);</span>
    }

    private static Squad load(League league, String team, Boolean reserves) throws IOException {

<span class="nc" id="L181">        File data = Config.get().getDataDirectory();</span>

<span class="nc" id="L183">        CharSource teamFile = Files.asCharSource(</span>
<span class="nc" id="L184">            new File(data, &quot;rosters/&quot; + league.getClass().getSimpleName() + &quot;/&quot; + team + &quot;.txt&quot;),</span>
            Charsets.UTF_8);

<span class="nc" id="L187">        CharStreams.copy(teamFile, Files.asCharSink(new File(data, team + &quot;.txt&quot;), Charsets.UTF_8));</span>

<span class="nc" id="L189">        return load(league, teamFile, reserves);</span>
    }

    private static Squad load(League league, CharSource source, Boolean reserves) throws IOException {
<span class="nc" id="L193">        List&lt;Player&gt; ps = Lists.newArrayList();</span>

<span class="nc bnc" id="L195" title="All 2 branches missed.">        for (String line : source.readLines()) {</span>
<span class="nc bnc" id="L196" title="All 8 branches missed.">            if (Strings.isNullOrEmpty(line) || line.startsWith(&quot;Name&quot;) || line.startsWith(&quot;----&quot;) || line.startsWith(&quot;#&quot;)) {</span>
<span class="nc" id="L197">                continue;</span>
            }

<span class="nc" id="L200">            String[] split = Splitter</span>
<span class="nc" id="L201">              .on(CharMatcher.WHITESPACE)</span>
<span class="nc" id="L202">              .splitToList(</span>
                  CharMatcher
                    .WHITESPACE
<span class="nc" id="L205">                    .collapseFrom(</span>
<span class="nc" id="L206">                      StringUtils.substringBefore(line, &quot;#&quot;), ' ')</span>
<span class="nc" id="L207">                    .trim())</span>
<span class="nc" id="L208">              .toArray(new String[] { });</span>

<span class="nc bnc" id="L210" title="All 2 branches missed.">            if (split.length &lt; 12) {</span>
<span class="nc" id="L211">                continue;</span>
            }

<span class="nc" id="L214">            String name = split[0];</span>
<span class="nc" id="L215">            Integer age = Integer.parseInt(split[1]);</span>

<span class="nc" id="L217">            Ratings ratings = Ratings</span>
<span class="nc" id="L218">                .builder(league)</span>
<span class="nc" id="L219">                .stopping(Integer.parseInt(split[3]))</span>
<span class="nc" id="L220">                .tackling(Integer.parseInt(split[4]))</span>
<span class="nc" id="L221">                .passing(Integer.parseInt(split[5]))</span>
<span class="nc" id="L222">                .shooting(Integer.parseInt(split[6]))</span>
<span class="nc" id="L223">                .build();</span>

<span class="nc" id="L225">            Ratings abilities = Ratings</span>
<span class="nc" id="L226">                .builder(league)</span>
<span class="nc" id="L227">                .stopping(Integer.parseInt(split[8]))</span>
<span class="nc" id="L228">                .tackling(Integer.parseInt(split[9]))</span>
<span class="nc" id="L229">                .passing(Integer.parseInt(split[10]))</span>
<span class="nc" id="L230">                .shooting(Integer.parseInt(split[11]))</span>
<span class="nc" id="L231">                .build();</span>

<span class="nc" id="L233">            Player p = Player.create(name, age, ratings, abilities);</span>

<span class="nc" id="L235">            p.setAggression(Integer.parseInt(split[7]));</span>

<span class="nc bnc" id="L237" title="All 2 branches missed.">            if (split.length &gt; 12) {</span>
                //System.out.println(Arrays.toString(split));
<span class="nc" id="L239">                p.setGames(Integer.parseInt(split[12]));</span>
            }

<span class="nc bnc" id="L242" title="All 4 branches missed.">            if (split.length &gt; 24 &amp;&amp; !split[24].equals(&quot;0&quot;)) {</span>
<span class="nc" id="L243">                p.injured();</span>
            }
<span class="nc bnc" id="L245" title="All 4 branches missed.">            if (split.length &gt; 25 &amp;&amp; !split[25].equals(&quot;0&quot;)) {</span>
<span class="nc" id="L246">                p.suspended();</span>
            }

<span class="nc bnc" id="L249" title="All 2 branches missed.">            if (split.length &gt; 26) {</span>
<span class="nc" id="L250">                p.setFitness(Integer.parseInt(split[26]));</span>
            }

<span class="nc" id="L253">            p.setComment(StringUtils.substringAfter(line, &quot;#&quot;));</span>

<span class="nc bnc" id="L255" title="All 2 branches missed.">            if (reserves) {</span>
<span class="nc" id="L256">                p.reserves();</span>
            }

<span class="nc" id="L259">            ps.add(p);</span>
<span class="nc" id="L260">        }</span>

<span class="nc" id="L262">        return new Squad(ps);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span></div></body></html>